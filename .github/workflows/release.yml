name: Release
on:
  push:
    tags:
      - 'v*.*.*'
      - 'v*.*.*-*'

jobs:
  release:
    environment: release
    runs-on: ubuntu-latest
    container:
      image: "registry.digitalocean.com/anemoi/bazelbase:latest"
      credentials:
        username: ${{ secrets.digitalocean_token }}
        password: ${{ secrets.digitalocean_token }}
      env:
        BAZELDIST_USERNAME: ${{ secrets.bazeldist_user }}
        BAZELDIST_PASSWORD: ${{ secrets.bazeldist_token }}
        GITHUB_ACTOR: Jtrim777
        GITHUB_EMAIL: jatrimble777@gmail.com
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v2
      - name: Set env
        run: |
          VTAG="${GITHUB_REF#refs/*/}"
          XVZN=$(echo -n "$VTAG" | sed s/v//)
          ISNAP=$(echo -n "$XVZN" | tr -dc '-' | awk '{ print length; }')
          RTYP=$([ $ISNAP -eq 0 ] && echo -n "release" || echo -n "snapshot")
          echo "RELEASE_VERSION=$XVZN" >> $GITHUB_ENV
          echo "RELEASE_TYPE=$RTYP" >> $GITHUB_ENV
      - name: Load Bazel
        run: |
          /usr/bin/installgcc
          bazel info
          bazel clean --expunge
      - name: Update version refs
        run: |
          OLDVZN=$(cat VERSION)
          echo -n "${{ env.RELEASE_VERSION }}" > VERSION
          sed -i "s/$OLDVZN/${{ env.RELEASE_VERSION }}/g" package/man/jvmutil.man
      - name: Commit version update
        uses: EndBug/add-and-commit@v7
        with:
          author_name: GitHub Actions
          author_email: Jtrim777
          message: 'Update versioning info'
          branch: main
          pull: 'NO-PULL'
          push: true
          tag: 'v${{ env.RELEASE_VERSION }} --force'
      - name: Deploy package
        run: bazel run //:deploy-pkg -- $RELEASE_TYPE
      - name: Deploy formula
        run: bazel run //:deploy-formula -- $RELEASE_TYPE
